<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Decks Scheduler</title>

    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
    <div id="root"></div>
</body>

<script type="text/babel">
    const { useState, useMemo, useEffect } = React

    const defaultStartHour = '18'
    const defaultStartMinute = '20'
    const defaultSlotCount = 14
    const defaultSlotHeight = 40 // mm
    const defaultSlotDuration = 20 // minutes

    const App = () => {
        const [numSlots, setNumSlots] = useState(defaultSlotCount)
        const [startHour, setStartHour] = useState(defaultStartHour)
        const [startMinute, setStartMinute] = useState(defaultStartMinute)
        const [slotHeight, setSlotHeight] = useState(defaultSlotHeight)
        const [defaultDuration, setDefaultDuration] = useState(defaultSlotDuration)
        const [showSettings, setShowSettings] = useState(true)
        const [slotConfigs, setSlotConfigs] = useState(Array.from({ length: defaultSlotCount }, () => ({})))
        const [editingSlot, setEditingSlot] = useState(null)

        // Adjust slot configs when number of slots changes
        useEffect(() => {
            setSlotConfigs(prevConfigs => {
                const newConfigs = Array.from({ length: numSlots }, (_, i) => prevConfigs[i] || {})
                return newConfigs
            })
        }, [numSlots])

        const slots = useMemo(() => {
            const time = new Date(2000, 1, 1, parseInt(startHour), parseInt(startMinute))

            return slotConfigs.slice(0, numSlots).map((config, index) => {
                const hour = String(time.getHours()).padStart(2, '0')
                const minute = String(time.getMinutes()).padStart(2, '0')
                const slotTime = `${hour}:${minute}`

                // update time with duration of slot, for next slot
                const duration = config.duration || defaultDuration
                time.setMinutes(time.getMinutes() + duration)

                return {
                    duration,
                    height: slotHeight,
                    time: slotTime,
                    index,
                    ...config,
                }
            })
        }, [slotConfigs, numSlots, slotHeight, defaultDuration, startHour, startMinute])

        // Calculate raffle and non-special slot counts for warning
        const raffleWarning = useMemo(() => {
            const activeSlots = slots.slice(0, numSlots)
            const totalRaffles = activeSlots.reduce((sum, slot) => sum + (slot.raffles || 0), 0)
            const nonSpecialSlots = activeSlots.filter(slot => !slot.special).length

            return {
                totalRaffles,
                nonSpecialSlots,
                hasWarning: totalRaffles !== nonSpecialSlots
            }
        }, [slots, numSlots])

        const updateSlotConfig = (index, config) => {
            setSlotConfigs(prev => {
                const newConfigs = [...prev]
                newConfigs[index] = config
                return newConfigs
            })
            setEditingSlot(null)
        }

        const deleteSlot = (index) => {
            setSlotConfigs(prev => {
                const newConfigs = [...prev]
                newConfigs.splice(index, 1)
                return newConfigs
            })
            setNumSlots(prev => prev - 1)
            setEditingSlot(null)
        }

        const insertSlot = (index, position) => {
            setSlotConfigs(prev => {
                const newConfigs = [...prev]
                const insertIndex = position === 'above' ? index : index + 1
                newConfigs.splice(insertIndex, 0, {})
                return newConfigs
            })
            setNumSlots(prev => prev + 1)
            setEditingSlot(null)
        }

        const autoUpdateRaffles = () => {
            setSlotConfigs(prev => {
                const newConfigs = [...prev]

                // First, count total non-special slots
                const nonSpecialIndices = []
                newConfigs.forEach((config, index) => {
                    if (!config.special) {
                        nonSpecialIndices.push(index)
                    }
                })

                const totalNonSpecial = nonSpecialIndices.length
                const isOdd = totalNonSpecial % 2 === 1

                // Clear all existing raffles first
                newConfigs.forEach((config, index) => {
                    if (!config.special) {
                        const { raffles, ...rest } = config
                        newConfigs[index] = rest
                    }
                })

                // always start with a raffle
                newConfigs[nonSpecialIndices[0]].raffles = 2

                if (isOdd) {
                    // For odd number of slots: (n-1)/2 raffles, last one is 3x
                    const numRaffles = (totalNonSpecial - 1) / 2
                    let raffleCount = 1

                    // Add 2x raffles to slots 1, 3, 5, etc.
                    for (let i = 1; i < nonSpecialIndices.length && raffleCount < numRaffles; i += 2) {
                        const slotIndex = nonSpecialIndices[i]
                        raffleCount++

                        // Make the last raffle 3x instead of 2x
                        if (raffleCount === numRaffles) {
                            newConfigs[slotIndex].raffles = 3
                        } else {
                            newConfigs[slotIndex].raffles = 2
                        }
                    }
                } else {
                    // For even number of slots: n/2 raffles, all 2x
                    for (let i = 1; i < nonSpecialIndices.length - 1; i += 2) {
                        const slotIndex = nonSpecialIndices[i]
                        newConfigs[slotIndex].raffles = 2
                    }
                }

                return newConfigs
            })
        }

        return (
            <div className="app-container">
                {showSettings && (
                    <div className="sidebar">
                        <h3>Open Decks Scheduler</h3>

                        <div className="control-group">
                            <label>Start Time</label>
                            <div className="time-inputs">
                                <input
                                    type="number"
                                    min="0"
                                    max="23"
                                    value={startHour}
                                    onChange={(e) => setStartHour(e.target.value.padStart(2, '0'))}
                                    className="time-input"
                                />
                                <span className="time-separator">:</span>
                                <input
                                    type="number"
                                    min="0"
                                    max="59"
                                    value={startMinute}
                                    onChange={(e) => setStartMinute(e.target.value.padStart(2, '0'))}
                                    className="time-input"
                                />
                            </div>
                        </div>

                        <div className="control-group">
                            <label htmlFor="numSlots">Number of Slots</label>
                            <input
                                id="numSlots"
                                type="number"
                                min="1"
                                max="30"
                                value={numSlots}
                                onChange={(e) => setNumSlots(parseInt(e.target.value) || defaultSlotCount)}
                            />
                        </div>

                        <div className="control-group">
                            <label htmlFor="duration">Default Duration (min)</label>
                            <input
                                id="duration"
                                type="number"
                                min="5"
                                max="120"
                                value={defaultDuration}
                                onChange={(e) => setDefaultDuration(parseInt(e.target.value) || defaultSlotDuration)}
                            />
                        </div>

                        <div className="control-group">
                            <label htmlFor="slotHeight">Slot Print Height (mm)</label>
                            <input
                                id="slotHeight"
                                type="number"
                                min="10"
                                max="300"
                                value={slotHeight}
                                onChange={(e) => setSlotHeight(parseInt(e.target.value) || defaultSlotHeight)}
                            />
                        </div>

                        {raffleWarning.hasWarning && (
                            <div className="raffle-warning">
                                <strong>‚ö†Ô∏è Warning:</strong><br />
                                You have {raffleWarning.nonSpecialSlots} free slot(s) but {raffleWarning.totalRaffles} raffle(s).
                            </div>
                        )}

                        <button
                            className="btn-base btn-sidebar btn-purple"
                            onClick={autoUpdateRaffles}
                        >
                            üé≤ Auto-update Raffles
                        </button>

                        <button
                            className="btn-base btn-sidebar btn-blue"
                            onClick={() => window.print()}
                        >
                            üñ®Ô∏è Print Schedule
                        </button>

                        <button
                            className="btn-base btn-sidebar btn-gray"
                            onClick={() => setShowSettings(false)}
                        >
                            Hide Settings
                        </button>
                    </div>
                )}

                {!showSettings && (
                    <button
                        className="show-sidebar-button"
                        onClick={() => setShowSettings(true)}
                    >
                        ‚öôÔ∏è
                    </button>
                )}

                <div className="schedule-container">
                    {raffleWarning.hasWarning && !showSettings && (
                        <div className="raffle-warning-top">
                            <strong>‚ö†Ô∏è Raffle Mismatch:</strong> {raffleWarning.totalRaffles} raffle(s) for {raffleWarning.nonSpecialSlots} slot(s)
                        </div>
                    )}
                    {slots.map((slot) => (
                        <Slot
                            key={slot.index}
                            slot={slot}
                            onEdit={showSettings ? () => setEditingSlot(slot.index) : null}
                        />
                    ))}
                </div>

                {editingSlot !== null && (
                    <SlotEditor
                        slot={slots[editingSlot]}
                        slotIndex={editingSlot}
                        defaultDuration={defaultDuration}
                        onSave={updateSlotConfig}
                        onDelete={deleteSlot}
                        onInsert={insertSlot}
                        onClose={() => setEditingSlot(null)}
                    />
                )}
            </div>
        )
    }

    const Slot = ({ slot, onEdit }) => (
        <div
            className={`slot ${slot.special ? 'special' : ''}`}
            style={{ height: `${slot.height * 3.45}px` }}
        >
            <div className="time-container">
                <div className="time">{slot.time}</div>
                {slot.raffles && (
                    <div className="raffle-info">{slot.raffles}x Raffle</div>
                )}
            </div>
            <div className="event-container">
                <div className="dj-set">
                    {slot.special ? (
                        <span>{slot.special}</span>
                    ) : (
                        <div className="write-space"></div>
                    )}
                </div>
            </div>
            {onEdit &&
                <button className="edit-slot-button" onClick={onEdit} title="Edit slot">
                    ‚úèÔ∏è
                </button>
            }
        </div>
    )

    const SlotEditor = ({ slot, slotIndex, defaultDuration, onSave, onDelete, onInsert, onClose }) => {
        const [special, setSpecial] = useState(slot.special || '')
        const [raffles, setRaffles] = useState(slot.raffles || 0)
        const [duration, setDuration] = useState(slot.duration || defaultDuration)
        const [showDeleteConfirm, setShowDeleteConfirm] = useState(false)

        const handleSave = () => {
            const config = {}
            if (special) config.special = special
            if (raffles > 0) config.raffles = raffles
            if (duration !== defaultDuration) config.duration = duration
            onSave(slotIndex, config)
        }

        const handleClear = () => {
            onSave(slotIndex, {})
        }

        const handleDelete = () => {
            setShowDeleteConfirm(true)
        }

        const confirmDelete = () => {
            onDelete(slotIndex)
            setShowDeleteConfirm(false)
        }

        const handleInsertAbove = () => {
            onInsert(slotIndex, 'above')
        }

        const handleInsertBelow = () => {
            onInsert(slotIndex, 'below')
        }

        return (
            <div className="modal-overlay" onClick={onClose}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                    <h3>Edit Slot {slotIndex + 1} ({slot.time})</h3>

                    <div className="modal-field">
                        <label>Special Content (leave empty for regular DJ slot)</label>
                        <input
                            type="text"
                            value={special}
                            onChange={(e) => setSpecial(e.target.value)}
                            placeholder="e.g., Featured DJ: XY / Social Break / ..."
                        />
                    </div>

                    <div className="modal-field">
                        <label>Number of Raffles</label>
                        <input
                            type="number"
                            value={raffles}
                            min="0"
                            max="10"
                            onChange={(e) => setRaffles(parseInt(e.target.value) || 0)}
                        />
                    </div>

                    <div className="modal-field">
                        <label>Duration (minutes)</label>
                        <input
                            type="number"
                            value={duration}
                            min="5"
                            max="120"
                            onChange={(e) => setDuration(parseInt(e.target.value) || defaultDuration)}
                        />
                    </div>

                    <div className="modal-actions">
                        <button className="btn-base btn-modal btn-green" onClick={handleSave}>Save</button>
                        <button className="btn-base btn-modal btn-orange" onClick={handleClear}>Clear</button>
                        <button className="btn-base btn-modal btn-gray" onClick={onClose}>Cancel</button>
                        <button className="btn-base btn-modal btn-light-blue" onClick={handleInsertAbove}>Add Slot Above</button>
                        <button className="btn-base btn-modal btn-light-blue" onClick={handleInsertBelow}>Add Slot Below</button>
                        <button className="btn-base btn-modal btn-red" onClick={handleDelete}>Delete Slot</button>
                    </div>

                    {showDeleteConfirm && (
                        <div className="delete-confirm">
                            <p>Are you sure you want to delete Slot {slotIndex + 1}?</p>
                            <div className="confirm-actions">
                                <button className="btn-base btn-confirm btn-red" onClick={confirmDelete}>Yes, Delete</button>
                                <button className="btn-base btn-confirm btn-gray" onClick={() => setShowDeleteConfirm(false)}>Cancel</button>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        )
    }

    const root = ReactDOM.createRoot(document.getElementById('root'))
    root.render(<App />)
</script>

<style>
    @page {
        size: A4;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Verdana';
        font-weight: bold;
        background: white;
        color: black;
        margin: 0;
        padding: 0;
    }

    .app-container {
        display: flex;
        min-height: 100vh;
    }

    .sidebar {
        width: 250px;
        background: #f8f8f8;
        border-right: 2px solid #ddd;
        padding: 20px;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
    }

    .sidebar h3 {
        margin-bottom: 20px;
        color: #333;
        font-size: 1.3rem;
    }

    .control-group {
        margin-bottom: 20px;
    }

    .control-group label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-size: 0.95rem;
    }

    .control-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1rem;
        font-weight: normal;
    }

    .time-inputs {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .time-input {
        width: 60px !important;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1rem;
        font-weight: normal;
        text-align: center;
    }

    .time-separator {
        font-size: 1.2rem;
        font-weight: bold;
    }

    .raffle-warning {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 4px;
        padding: 15px;
        margin-top: 20px;
        color: #856404;
        font-size: 0.95rem;
    }

    .raffle-warning strong {
        color: #856404;
    }

    .raffle-warning-top {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 4px;
        padding: 24px 30px;
        margin-bottom: 40px;
        color: #856404;
        font-size: 2rem;
        text-align: center;
    }

    /* Shared Button Styles */
    .btn-base {
        padding: 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        color: white;
        transition: background 0.2s;
    }

    .btn-sidebar {
        width: 100%;
        font-size: 1rem;
        margin-top: 20px;
    }

    /* Button Color Variants */
    .btn-purple {
        background: #9c27b0;
    }

    .btn-blue {
        background: #1976D2;
    }

    .btn-gray {
        background: #666;
    }

    .btn-green {
        background: #4CAF50;
    }

    .btn-orange {
        background: #ff9800;
    }

    .btn-red {
        background: #f44336;
    }

    .btn-light-blue {
        background: #2196F3;
    }

    .show-sidebar-button {
        position: fixed;
        top: 20px;
        left: 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #666;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .schedule-container {
        flex: 1;
        padding: 40px 140px 40px 40px;
        max-width: 210mm;
        margin: 0 auto;
        transform: scale(0.45);
        transform-origin: top center;
    }

    @media print {

        .sidebar,
        .show-sidebar-button,
        .raffle-warning,
        .raffle-warning-top {
            display: none;
        }

        .app-container {
            display: block;
        }

        .schedule-container {
            padding: 0;
            transform: scale(1);
        }
    }

    .slot {
        display: flex;
        align-items: center;
        page-break-inside: avoid;
        margin-bottom: 10px;
        border: 2px solid #ddd;
        position: relative;
    }

    .edit-slot-button {
        position: absolute;
        right: -100px;
        top: 50%;
        transform: translateY(-50%);
        width: 72px;
        height: 72px;
        border-radius: 50%;
        border: 2px solid #ccc;
        background: white;
        cursor: pointer;
        font-size: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    button:hover {
        filter: brightness(85%);
    }

    /* Remove extra margin for last slot */
    /* .slot:last-child {
        margin-bottom: 0;
    } */

    .time-container {
        min-width: 120px;
        padding: 0 25px;
        text-align: center;
    }

    .time {
        font-size: 2.5rem;
    }

    .raffle-info {
        color: #444;
        font-size: 1.5rem;
        padding-top: 5px;
    }

    .event-container {
        height: 100%;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .dj-set {
        display: flex;
        align-items: center;
        padding-left: 10px;
        font-size: 2.5rem;
        height: 100%;
    }

    .write-space {
        flex: 1;
        min-height: 75%;
        border-bottom: 3px dotted #888;
        margin-right: 30px;
    }

    .special {
        background: linear-gradient(135deg, #f5f5f5 0%, #e5e5e5 100%);
        border: 3px solid black;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        padding: 30px;
        width: 500px;
        max-width: 90%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-content h3 {
        margin-bottom: 20px;
        font-size: 1.4rem;
        color: #333;
    }

    .modal-field {
        margin-bottom: 20px;
    }

    .modal-field label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-size: 0.95rem;
        font-weight: normal;
    }

    .modal-field input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1rem;
        font-weight: normal;
    }

    .modal-actions {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-top: 25px;
    }

    .btn-modal {
        font-size: 0.95rem;
    }

    /* Delete Confirmation Dialog */
    .delete-confirm {
        margin-top: 20px;
        padding: 20px;
        background: #ffebee;
        border: 2px solid #f44336;
        border-radius: 4px;
    }

    .delete-confirm p {
        margin-bottom: 15px;
        color: #c62828;
        font-weight: bold;
        text-align: center;
    }

    .confirm-actions {
        display: flex;
        gap: 10px;
    }

    .btn-confirm {
        flex: 1;
        font-size: 1rem;
    }

    @media print {
        .edit-slot-button {
            display: none !important;
        }
    }
</style>

</html>
